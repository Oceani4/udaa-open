<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Мета-теги для превью в мессенджерах -->
  <meta property="og:title" content="Spot.It - Shared Content">
  <meta property="og:description" content="Point. Snap. Done. Explore with Spot.It!">
  <meta property="og:image" content="https://spotit.live/images/preview-image.jpg">
  <meta property="og:url" content="https://spotit.live/share/<%- shareId %>">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Spot.It - Shared Content">
  <meta name="twitter:description" content="Point. Snap. Done. Explore with Spot.It!">
  <meta name="twitter:image" content="https://spotit.live/images/preview-image.jpg">
  <!-- Мета-тег для попытки редиректа -->
  <meta http-equiv="refresh" content="0; url=spotit://share/<%- shareId %>">
  <title>Spot.It - Point. Snap. Done.</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    .loader {
      border: 8px solid #f3f3f3; /* Light grey */
      border-top: 8px solid #3498db; /* Blue */
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
  </style>
  <script>
    // Функция для получения параметра из URL
    function getQueryParam(param) {
      // const urlParams = new URLSearchParams(window.location.search);
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Определение платформы (Android, iOS или не определено)
    function detectPlatform() {
      const userAgent = navigator.userAgent;
      if (/android/i.test(userAgent)) {
        return "Android";
      } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return "iOS";
      } else {
        return "Not detected";
      }
    }

    // Определение источника (браузер/приложение)
    function detectSource() {
      const userAgent = navigator.userAgent.toLowerCase();
      const referrer = document.referrer.toLowerCase();
      if (referrer.includes('instagram') || userAgent.includes('instagram')) {
        return 'Instagram';
      } else if (referrer.includes('telegram') || userAgent.includes('telegram')) {
        return 'Telegram';
      } else if (referrer.includes('whatsapp') || userAgent.includes('whatsapp')) {
        return 'WhatsApp';
      } else if (userAgent.includes('chrome')) {
        return 'Chrome';
      } else if (userAgent.includes('safari')) {
        return 'Safari';
      } else {
        return 'Unknown';
      }
    }

    // Заготовка для отправки уникальных данных устройства и shareId на сервер
    function sendDeviceDataToApi(shareId) {
      const platform = detectPlatform();
      const userAgent = navigator.userAgent;
      const screenWidth = window.screen.width;
      const screenHeight = window.screen.height;
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const languages = navigator.languages.join(',');

      // Создаем уникальный "отпечаток" устройства (простая хэш-функция для примера)
      const deviceFingerprint = btoa(userAgent + screenWidth + screenHeight + timezone + languages); // Base64 для упрощения

      const data = {
        deviceFingerprint: deviceFingerprint,
        shareId: shareId,
        platform: platform,
        userAgent: userAgent,
        screenResolution: `${screenWidth}x${screenHeight}`,
        timezone: timezone,
        languages: languages
      };

      // Отправка на API (замените URL на ваш реальный API-эндпоинт)
      fetch('https://your-api-server.com/save-share-id', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
              .then(response => response.json())
              .then(result => {
                console.log('API response:', result);
                document.getElementById('deviceDataResponse').textContent = `deviceDataResponse: ${JSON.stringify(result, null, 2)}`;
              })
              .catch(error => {
                console.error('API error:', error);
              });
    }

    window.onload = function() {
      // Показываем лоадер
      document.getElementById('loader').classList.remove('hidden');
      // // const shareId = path.split('/share/')[1];
      // const shareId = search.split('?share=')[1];
      // Получаем shareId из URL
      const shareId = getQueryParam('share') || ''; // Значение по умолчанию, если не указано
      console.log('1. shareId: ', shareId)

      const isAndroid = /Android/i.test(navigator.userAgent)

      // Вывод в консоль источника клика
      const source = detectSource();
      console.log(`2. User clicked from: ${source}`);

      // Попытка редиректа на кастомную схему
      if (shareId) {
        // Отправляем данные на API (заготовка)
        sendDeviceDataToApi(shareId);

        const appUrl = `spotit://share/${shareId}`;
        window.location.href = appUrl;

      }

      setTimeout(() => {
        document.getElementById('loader').classList.add('hidden');
        window.location.href = isAndroid
                ? `https://play.google.com/store/apps/details?id=com.spotit.live&referrer=utm_source%3Dspotit://share/${shareId}`
                : 'https://apps.apple.com/gb/app/spotit-live/id6740921502'
      }, 5000);

      // Попытка открытия приложения (пример редиректа, закомментировано как в предыдущих версиях)
      const platform = detectPlatform();


    };
  </script>
</head>
<body>
<h1>Spot.It - Point. Snap. Done.</h1>
<p>Opening Spot.It app...</p>
<div id="loader" class="loader hidden"></div> <!-- Лоадер скрыт по умолчанию -->
<div class="data-item" id="deviceDataResponse">deviceDataResponse: Detecting...</div>
</body>
</html>
